# MetaBAT2 v2.18

Metagenome binning tool for reconstructing genomes from metagenomic assemblies using coverage depth patterns.

## Official Documentation
- Bitbucket: https://bitbucket.org/berkeleylab/metabat
- Bioconda: https://bioconda.github.io/recipes/metabat2/README.html
- Version: 2.18

## Installation

**Conda (recommended):**
```bash
conda install -c bioconda metabat2
# or
mamba install -c bioconda metabat2
```

**From source:**
```bash
wget https://bitbucket.org/berkeleylab/metabat/get/master.tar.gz
tar xzvf master.tar.gz
cd berkeleylab-metabat-*
mkdir build && cd build
cmake .. && make && make test && make install
```

## Key Command-Line Flags

| Flag | Description | Default |
|------|-------------|---------|
| `-i, --inFile` | Input contigs (FASTA/gzipped) | Required |
| `-a, --abdFile` | Abundance/depth file (tab-delimited) | Optional |
| `-o, --outFile` | Output bin file base name | Required |
| `-m, --minContig` | Minimum contig length | 2500 bp |
| `-s, --minClsSize` | Minimum bin size | 200000 bp |
| `--maxP` | Sensitivity control (max percentage for bin membership) | 95 |
| `--minS` | Specificity threshold (min score for cluster seed) | 60 |
| `-t, --numThreads` | Thread count (0 = all cores) | 0 |
| `--seed` | Random seed for reproducibility | - |
| `--saveCls` | Save cluster membership file | - |
| `--unbinned` | Save unbinned contigs separately | - |
| `--noAdd` | Disable adding small contigs to bins | - |

## Common Usage Examples

### Easy mode with helper script
```bash
runMetaBat.sh contigs.fasta sample1.bam sample2.bam sample3.bam
```

### Standard two-step workflow
```bash
# Step 1: Generate depth file from BAM files
jgi_summarize_bam_contig_depths --outputDepth depth.txt *.bam

# Step 2: Run MetaBAT2
metabat2 -i contigs.fasta -a depth.txt -o bins/bin -t 16
```

### Single-sample binning (suboptimal, multi-sample preferred)
```bash
metabat2 -i contigs.fasta -o bins/bin -t 8
```

### With reproducibility and unbinned contigs
```bash
metabat2 -i contigs.fasta -a depth.txt -o bins/bin \
  --seed 12345 --unbinned --saveCls -t 16
```

## Input Requirements

**Contigs file:**
- FASTA format (plain or gzipped)
- Minimum length threshold recommended: 1000-2500 bp

**Depth file (optional but strongly recommended):**
- Tab-delimited format
- Column 1: Contig names (matching FASTA headers)
- Remaining columns: Mean and variance of coverage depth per sample
- Generated by `jgi_summarize_bam_contig_depths` from sorted BAM files

Example depth file:
```
contigName          contigLen  totalAvgDepth  sample1.bam  sample1.bam-var  sample2.bam  sample2.bam-var
k141_1000001        2315       15.67          12.3         45.2             19.1         52.8
k141_1000002        4892       28.91          25.4         78.3             32.5         88.1
```

**Important:** BAM files must be sorted before generating depth file.

## Output Format

**Bins:** Individual FASTA files named `{outFile}.{bin_number}.fa`
```
bins/bin.1.fa
bins/bin.2.fa
bins/bin.3.fa
...
```

**Optional outputs:**
- `{outFile}.unbinned.fa`: Contigs not assigned to any bin (with `--unbinned`)
- `{outFile}.cls`: Cluster membership matrix (with `--saveCls`)

## Parameter Tuning

**MetaBAT2 requires virtually no parameter optimization** - it adapts automatically. However:

**For high-quality assemblies:**
- Decrease `-m` (minimum contig length) to 1500 or 1000 bp
- May increase sensitivity for small bins

**For poor-quality assemblies:**
- Reduce `--maxP` (e.g., 80-90)
- Reduce `--maxEdges` to avoid over-connecting contigs

**For low completeness:**
- Increase `--maxEdges` up to 500
- Helps recover more complete bins

**To reduce contamination:**
- Use `--noAdd` to prevent small contigs from being added
- Increase `--minS` threshold

## Multi-Sample Binning

MetaBAT2 performs best with **3+ samples** from the same environment:
- Differential coverage patterns improve binning accuracy
- More samples = better separation of closely related organisms
- Single-sample binning is possible but less accurate

## Performance Tips

1. **Use multiple samples**: 3-10 samples from same environment is optimal
2. **Sort BAM files**: `samtools sort` before running `jgi_summarize_bam_contig_depths`
3. **Threading**: Use `-t` for parallel processing (scales well)
4. **Minimum contig length**: Default 2500 bp balances sensitivity and specificity
5. **Reproducibility**: Set `--seed` for consistent results across runs
6. **Memory**: Efficient with memory; can handle large assemblies

## Integration with QC Tools

After binning, assess bin quality:
```bash
# For bacteria/archaea
checkm2 predict --input bins/ --output-directory qc/ -t 16

# For contamination detection
gunc run --input_dir bins/ --db_file gunc_db --threads 16
```

## Common Issues

- **Too few bins**: Increase samples, check coverage variation
- **High contamination**: Use `--noAdd`, increase `--minS`
- **Low completeness**: Increase `--maxEdges`, decrease `-m`
- **Empty bins**: Check depth file format, ensure adequate coverage

## Citation

Kang DD, Li F, Kirton E, Thomas A, Egan R, An H, Wang Z. (2019)
MetaBAT 2: an adaptive binning algorithm for robust and efficient genome reconstruction from metagenome assemblies.
*PeerJ* 7:e7359. https://doi.org/10.7717/peerj.7359
